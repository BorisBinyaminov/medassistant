name: Build & Deploy (GHCR → VPS)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lowercase repo
        run: echo "REPO_LC=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push bot image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: bot/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.REPO_LC }}/bot:latest
            ghcr.io/${{ env.REPO_LC }}/bot:sha-${{ github.sha }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    env:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_PORT: ${{ secrets.VPS_PORT }}
      VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
      VPS_PASSPHRASE: ${{ secrets.VPS_PASSPHRASE }}
      DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}

      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_ORG: ${{ secrets.OPENAI_ORG }}
      OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
      MODEL_REASONING: ${{ secrets.MODEL_REASONING }}
      MODEL_FRIENDLY: ${{ secrets.MODEL_FRIENDLY }}
      DEBUG: ${{ secrets.DEBUG }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          set -euo pipefail
          check() { [ -n "$2" ] || { echo "❌ Missing secret: $1"; exit 1; }; }
          check DEPLOY_DIR            "$DEPLOY_DIR"
          check VPS_HOST              "$VPS_HOST"
          check VPS_USER              "$VPS_USER"
          check VPS_PORT              "$VPS_PORT"
          check VPS_SSH_KEY           "$VPS_SSH_KEY"
          # VPS_PASSPHRASE может быть пустым, если ключ без пароля — не проверяем

      - name: Render compose with GHCR image & absolute DEPLOY_DIR
        run: |
          set -euo pipefail
          REPO_LC="${GITHUB_REPOSITORY,,}"
          IMG="ghcr.io/${REPO_LC}/bot:latest"
          sed "s|__BOT_IMAGE__|${IMG}|g" docker-compose.yml > docker-compose.rendered.yml
          sed -i "s|\${DEPLOY_DIR}|${DEPLOY_DIR}|g" docker-compose.rendered.yml
          echo "== Compose debug =="; grep -nE '^\s*image:|^\s*-\s*/' docker-compose.rendered.yml || true

      - name: Pack source tree for server (git ls-files)
        run: |
          set -euo pipefail
          git ls-files | grep -vE '^\.github/|^\.env$|^artifacts/|^README\.md$' > /tmp/filelist.txt
          tar -czf src.tgz -T /tmp/filelist.txt
          ls -lh src.tgz

      - name: Verify payload exists
        run: |
          set -euo pipefail
          test -s ./docker-compose.rendered.yml
          test -s ./src.tgz

      - name: Prepare SSH key (outside workspace)
        id: prep-key
        shell: bash
        run: |
          set -euo pipefail
          KEY_PATH="$RUNNER_TEMP/medassistant_id"
          printf '%s\n' "$VPS_SSH_KEY" > "$KEY_PATH"
          sed -i 's/\r$//' "$KEY_PATH"
          chmod 600 "$KEY_PATH"
          echo "KEY_PATH=$KEY_PATH" >> "$GITHUB_OUTPUT"

      - name: Ensure deploy dir exists
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key_path: ${{ steps.prep-key.outputs.KEY_PATH }}
          passphrase: ${{ secrets.VPS_PASSPHRASE }}
          script: |
            set -euo pipefail
            mkdir -p "${{ secrets.DEPLOY_DIR }}"


      - name: Upload compose & source (SCP)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USER }}
          port: ${{ env.VPS_PORT }}
          key_path: ${{ steps.prep-key.outputs.KEY_PATH }}
          passphrase: ${{ env.VPS_PASSPHRASE }}
          source: "./docker-compose.rendered.yml,./src.tgz"
          target: "${{ env.DEPLOY_DIR }}/"
          overwrite: true
          debug: true

      - name: Deploy on server (compose up -d)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key_path: ${{ steps.prep-key.outputs.KEY_PATH }}
          passphrase: ${{ secrets.VPS_PASSPHRASE }}
          script: |
            set -euo pipefail

            cd "${{ secrets.DEPLOY_DIR }}"

            mkdir -p artifacts
            tar xzf src.tgz
            rm -f src.tgz
            mv -f docker-compose.rendered.yml docker-compose.yml

            # генерим .env: подставляем secrets на стороне раннера (НЕ $VAR на сервере)
            cat > .env <<ENV
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            OPENAI_ORG=${{ secrets.OPENAI_ORG }}
            OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
            MODEL_REASONING=${{ secrets.MODEL_REASONING }}
            MODEL_FRIENDLY=${{ secrets.MODEL_FRIENDLY }}
            DEBUG=${{ secrets.DEBUG }}
            ENV
            chmod 600 .env

            # при необходимости логин в GHCR (если образ приватный):
            # echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin

            docker compose up -d --force-recreate
            docker compose ps
            CID="$(docker compose ps -q bot)"
            docker inspect -f '{{range .Mounts}}{{.Source}} => {{.Destination}}{{println}}{{end}}' "$CID" || true
